name: dbt Analytics Development Lifecycle (ADLC)

on:
  push:
    branches:
      - prod
      - qa
  pull_request:
    branches:
      - qa
      - prod

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
  DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
  DBT_PROFILES_DIR: ./

jobs:
  linting:
    name: Lint SQL with SQLFluff
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install sqlfluff sqlfluff-templater-dbt dbt-databricks
          dbt deps

      - name: Run SQLFluff Lint
        run: |
          sqlfluff lint models/ --dialect databricks

  slim-ci-qa:
    name: QA - Slim CI (state:modified+)
    if: github.event_name == 'pull_request' && github.base_ref == 'qa'
    runs-on: ubuntu-latest
    needs: linting
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dbt
        run: pip install dbt-databricks

      - name: Install dbt dependencies
        run: dbt deps

      # Para Slim CI, necesitamos el manifest.json del último build exitoso en QA.
      # En un escenario real, descargarías esto de un bucket S3 o Artifact de GitHub.
      # Aquí simulamos la descarga pre-configurada localmente.
      - name: Get Manifest for Deferral
        run: |
          mkdir -p target_base
          echo "Simulated fetch of prior manifest.json to target_base/manifest.json"
          # dbt api call to get manifest.json or aws s3 cp s3://path_to_manifest/manifest.json ./target_base/

      - name: Run Slim CI
        run: |
          # The real command requires a valid manifest. For demonstration, we use state deferral syntax.
          dbt build --select state:modified+ --state ./target_base --target qa

  deploy-prod:
    name: Deploy to Production & Generate Docs
    if: github.event_name == 'push' && github.ref == 'refs/heads/prod'
    runs-on: ubuntu-latest
    needs: linting
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dbt
        run: pip install dbt-databricks

      - name: Install dbt dependencies
        run: dbt deps

      - name: Run Deploy to Production
        run: |
          dbt build --target prod

      - name: Generate dbt Docs
        run: |
          dbt docs generate --target prod

      - name: Publish Docs (Example to GitHub Pages)
        # Using a popular action to deploy the 'target' directory which contains index.html, manifest.json, catalog.json
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target
